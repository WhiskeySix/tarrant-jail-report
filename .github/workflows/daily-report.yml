name: Daily Jail Report

on:
  schedule:
    - cron: "30 13 * * *"  # 13:30 UTC = 7:30am CST
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (Chromium)
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium
          python -m pip install --upgrade pip

      - name: Install Python deps
        run: |
          pip install -r requirements.txt

      - name: Run report
        env:
          BOOKED_BASE_URL: ${{ secrets.BOOKED_BASE_URL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python report.py

      - name: Commit report artifacts
        run: |
          git config user.name "dailyjailreports-bot"
          git config user.email "actions@users.noreply.github.com"
          git add reports/*.html reports/*.pdf || true
          git commit -m "Daily report: $(date -u +'%Y-%m-%d')" || echo "No changes to commit"
          git push
